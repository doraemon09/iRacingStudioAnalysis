<div id="Charts" class="row my-2" style="display: none;">
    <div class="col-md-12">
        <div class="row my-2">
            <h3
                data-en="{{ yaml_info['General']['Button']['Charts']['Label']['en'] }}"
                data-jp="{{ yaml_info['General']['Button']['Charts']['Label']['jp'] }}"
            >
                {{ yaml_info['General']['Button']['Charts']['Label']['en'] }}
            </h3>
            <div class="col-md-6 col-12">
                <div id="chartDeltaLapTime"></div>
            </div>
            <div class="col-md-6 col-12">
                <div id="chartDeltaSpeed"></div>
            </div>

            <script>
                $(document).ready(function() {
                    /*
                        =========================
                        Delta: Lap Time
                        =========================
                    */
                    var chartDeltaLapTime_traces = [];

                    // Show message when 1 lap only
                    // therefore no data to compare with
                    {% if (charts_info | length) == 1 %}
                        chartDeltaLapTime_traces.push({
                            x: [0.5],
                            y: [0.5],
                            mode: 'text',
                            text: ['No Data Available'],
                            textfont: {
                                size: 20,
                                color: 'red',
                            },
                            hoverinfo: 'none',
                            showlegend: false,
                        });
                    {% else %}
                        {% for lap, data in charts_info.items() %}
                            var laptimes_cleaned = {{ data['LapTime'] | tojson }}.map(lapTimeFormat);

                            chartDeltaLapTime_traces.push({
                                x: {{ data['Distance'] | tojson }}, // Switched out `DistanceRefLap`
                                y: {{ data['LapTimeDelta'] | tojson }},
                                mode: 'lines',
                                name: 'Lap {{ lap }}',
                                customdata: laptimes_cleaned,
                                hovertemplate: '‚è±Ô∏è %{customdata}',
                                //visible: {% if loop.index == data['LapBest'] %} true {% else %} 'legendonly' {% endif %},
                            });
                        {% endfor %}
                    {% endif %}

                    var chartDeltaLapTime_layout = {
                        autosize: true,
                        showlegend: true,
                        title: 'Delta: Lap Time',
                        xaxis: {
                            title: 'Distance (m)',
                        },
                        yaxis: {
                            title: 'Lap Time Delta (s)',
                        },
                    };

                    Plotly.newPlot(
                        'chartDeltaLapTime',
                        chartDeltaLapTime_traces,
                        chartDeltaLapTime_layout,
                    );

                    /*
                        =========================
                        Delta: Speed
                        =========================
                    */
                    var chartDeltaSpeed_traces = [];

                    // Show message when 1 lap only
                    // therefore no data to compare with
                    {% if (charts_info | length) == 1 %}
                        chartDeltaSpeed_traces.push({
                            x: [0.5],
                            y: [0.5],
                            mode: 'text',
                            text: ['No Data Available'],
                            textfont: {
                                size: 20,
                                color: 'red',
                            },
                            hoverinfo: 'none',
                            showlegend: false,
                        });
                    {% else %}
                        {% for lap, data in charts_info.items() %}
                            var speeds_kmh = {{ data['Speed'] | tojson }}.map(speed => (speed * 3.6).toFixed(2));

                            chartDeltaSpeed_traces.push({
                                x: {{ data['Distance'] | tojson }}, // Switched out `DistanceRefLap`
                                y: {{ data['SpeedDelta'] | tojson }},
                                mode: 'lines',
                                name: 'Lap {{ lap }}',
                                customdata: speeds_kmh,
                                hovertemplate: 'üèéÔ∏è %{customdata} kph',
                                //visible: {% if loop.index == data['LapBest'] %} true {% else %} 'legendonly' {% endif %},
                            });
                        {% endfor %}
                    {% endif %}

                    var chartDeltaSpeed_layout = {
                        autosize: true,
                        showlegend: true,
                        title: 'Delta: Speed',
                        xaxis: {
                            title: 'Distance (m)',
                        },
                        yaxis: {
                            title: 'Speed Delta (m/s)',
                        },
                    };

                    Plotly.newPlot(
                        'chartDeltaSpeed',
                        chartDeltaSpeed_traces,
                        chartDeltaSpeed_layout,
                    );

                    /*
                        =========================
                        Sync hover on Lap Time & Speed delta charts
                        =========================
                    */
                    var chartDeltaLapTime = document.getElementById('chartDeltaLapTime');
                    var chartDeltaSpeed = document.getElementById('chartDeltaSpeed');

                    chartDeltaLapTime.on('plotly_hover', function(data) {
                        var curveNumber = data.points[0].curveNumber;
                        var pointIndex = data.points[0].pointIndex;

                        Plotly.Fx.hover('chartDeltaSpeed', [{
                            curveNumber: curveNumber, // match lap trace
                            pointNumber: pointIndex, // match point within the lap trace
                        }]);
                    });

                    chartDeltaLapTime.on('plotly_unhover', function(data) {
                        Plotly.Fx.unhover('chartDeltaSpeed');
                    });

                    chartDeltaSpeed.on('plotly_hover', function(data) {
                        var curveNumber = data.points[0].curveNumber;
                        var pointIndex = data.points[0].pointIndex;

                        Plotly.Fx.hover('chartDeltaLapTime', [{
                            curveNumber: curveNumber, // match lap trace
                            pointNumber: pointIndex, // match point within the lap trace
                        }]);
                    });

                    chartDeltaSpeed.on('plotly_unhover', function(data) {
                        Plotly.Fx.unhover('chartDeltaLapTime');
                    });
                });
            </script>
        </div>

        <div class="row my-2">
            <div class="col-md-6 col-12">
                <div id="chartBrakeThrottle"></div>
            </div>
            <div class="col-md-6 col-12">
                <div id="chartSpeedGear"></div>
            </div>

            <!-- Ployly chart -->
            <script>
                $(document).ready(function() {
                    /*
                        =========================
                        Brake and Throttle
                        =========================
                    */
                    var chartBrakeThrottle_traces = [];

                    {% for lap, data in charts_info.items() %}
                        var throttle_cleaned = {{ data['Throttle'] | tojson }}.map(throttle => throttle.toFixed(3));

                        chartBrakeThrottle_traces.push({
                            x: {{ data['Distance'] | tojson }},
                            y: {{ data['Throttle'] | tojson }},
                            yaxis: 'y1',
                            mode: 'lines',
                            name: 'L{{ lap }} Throttle',
                            customdata: throttle_cleaned,
                            hovertemplate: 'üü¢ %{customdata}&nbsp;',
                            visible: {% if lap == laps_report_info['TopLaps'][0] %} true {% else %} 'legendonly' {% endif %},
                        });

                        var brake_cleaned = {{ data['Brake'] | tojson }}.map(brake => brake.toFixed(3));

                        chartBrakeThrottle_traces.push({
                            x: {{ data['Distance'] | tojson }},
                            y: {{ data['Brake'] | tojson }},
                            yaxis: 'y2',
                            mode: 'lines',
                            name: 'L{{ lap }} Brake',
                            customdata: brake_cleaned,
                            hovertemplate: 'üî¥ %{customdata}&nbsp;',
                            visible: {% if lap == laps_report_info['TopLaps'][0] %} true {% else %} 'legendonly' {% endif %},
                        });
                    {% endfor %}

                    var chartBrakeThrottle_layout = {
                        autosize: true,
                        showlegend: true,
                        title: 'Brake and Throttle',
                        xaxis: {
                            title: 'Distance (m)',
                        },
                        yaxis: {
                            title: 'Throttle (%)',
                            side: 'left',
                            overlaying: 'y2'
                        },
                        yaxis2: {
                            title: 'Brake (%)',
                            side: 'right',
                        },
                        legend: {
                            x: 1.1,
                            y: 1,
                            xanchor: 'left',
                            yanchor: 'top',
                        },
                    };

                    Plotly.newPlot(
                        'chartBrakeThrottle',
                        chartBrakeThrottle_traces,
                        chartBrakeThrottle_layout,
                    );

                    /*
                        =========================
                        Speed and Gear
                        =========================
                    */
                    var chartSpeedGear_traces = [];

                    {% for lap, data in charts_info.items() %}
                        var speeds_kmh = {{ data['Speed'] | tojson }}.map(speed => (speed * 3.6).toFixed(2));

                        chartSpeedGear_traces.push({
                            x: {{ data['Distance'] | tojson }},
                            y: speeds_kmh,
                            yaxis: 'y1',
                            mode: 'lines',
                            name: 'L{{ lap }} Speed',
                            hovertemplate: 'üèéÔ∏è %{y} kph',
                            visible: {% if lap == laps_report_info['TopLaps'][0] %} true {% else %} 'legendonly' {% endif %},
                        });

                        chartSpeedGear_traces.push({
                            x: {{ data['Distance'] | tojson }},
                            y: {{ data['Gear'] | tojson }},
                            yaxis: 'y2',
                            mode: 'markers',
                            marker: {
                                size: 4,
                                symbol: 'circle',
                            },
                            name: 'L{{ lap }} Gear',
                            hovertemplate: '‚öôÔ∏è %{y}&nbsp;',
                            visible: {% if lap == laps_report_info['TopLaps'][0] %} true {% else %} 'legendonly' {% endif %},
                        });
                    {% endfor %}

                    var chartSpeedGear_layout = {
                        autosize: true,
                        showlegend: true,
                        title: 'Speed and Gears',
                        xaxis: {
                            title: 'Distance (m)',
                        },
                        yaxis: {
                            title: 'Speed (kph)',
                            side: 'left',
                            overlaying: 'y2'
                        },
                        yaxis2: {
                            title: 'Gear',
                            side: 'right',
                            dtick: 1,
                        },
                        legend: {
                            x: 1.1,
                            y: 1,
                            xanchor: 'left',
                            yanchor: 'top',
                        },
                    };

                    Plotly.newPlot(
                        'chartSpeedGear',
                        chartSpeedGear_traces,
                        chartSpeedGear_layout,
                    );

                    /*
                        =========================
                        Sync hover on Brake/Throttle and Speed/Gear
                        =========================
                    */
                    var chartBrakeThrottle = document.getElementById('chartBrakeThrottle');
                    var chartSpeedGear = document.getElementById('chartSpeedGear');

                    chartBrakeThrottle.on('plotly_hover', function(data) {
                        var curveNumber = data.points[0].curveNumber;
                        var pointIndex = data.points[0].pointIndex;

                        Plotly.Fx.hover('chartSpeedGear', [{
                            curveNumber: curveNumber, // match lap trace
                            pointNumber: pointIndex, // match point within the lap trace
                        }]);
                    });

                    chartBrakeThrottle.on('plotly_unhover', function(data) {
                        Plotly.Fx.unhover('chartSpeedGear');
                    });

                    chartSpeedGear.on('plotly_hover', function(data) {
                        var curveNumber = data.points[0].curveNumber;
                        var pointIndex = data.points[0].pointIndex;

                        Plotly.Fx.hover('chartBrakeThrottle', [{
                            curveNumber: curveNumber, // match lap trace
                            pointNumber: pointIndex, // match point within the lap trace
                        }]);
                    });

                    chartSpeedGear.on('plotly_unhover', function(data) {
                        Plotly.Fx.unhover('chartBrakeThrottle');
                    });
                });
            </script>
        </div>

        <div class="row my-2">
            <div class="col-md-6 col-12">
                <div id="chartSpeedFuelUsage"></div>
            </div>
            <div class="col-md-6 col-12">
                <div id="chartSteeringAngleTorque"></div>
            </div>

            <!-- Ployly chart -->
            <script>
                $(document).ready(function() {
                    /*
                        =========================
                        Speed and Fuel Usage
                        =========================
                    */
                    var chartSpeedFuelUsage_traces = [];

                    {% for lap, data in charts_info.items() %}
                        var speeds_kmh = {{ data['Speed'] | tojson }}.map(speed => (speed * 3.6).toFixed(2));

                        chartSpeedFuelUsage_traces.push({
                            x: {{ data['Distance'] | tojson }},
                            y: speeds_kmh,
                            yaxis: 'y1',
                            mode: 'lines',
                            name: 'L{{ lap }} Speed',
                            hovertemplate: 'üèéÔ∏è %{y} kph',
                            visible: {% if lap == laps_report_info['TopLaps'][0] %} true {% else %} 'legendonly' {% endif %},
                        });

                        var fuel_cleaned = {{ data['FuelUsePerHour'] | tojson }}.map(fuel => fuel.toFixed(3));

                        chartSpeedFuelUsage_traces.push({
                            x: {{ data['Distance'] | tojson }},
                            y: {{ data['FuelUsePerHour'] | tojson }},
                            yaxis: 'y2',
                            mode: 'lines',
                            name: 'L{{ lap }} Fuel',
                            customdata: fuel_cleaned,
                            hovertemplate: '‚õΩ %{customdata} l/h',
                            visible: {% if lap == laps_report_info['TopLaps'][0] %} true {% else %} 'legendonly' {% endif %},
                        });
                    {% endfor %}

                    var chartSpeedFuelUsage_layout = {
                        autosize: true,
                        showlegend: true,
                        title: 'Speed and Fuel Use Per Hour',
                        xaxis: {
                            title: 'Distance (m)',
                        },
                        yaxis: {
                            title: 'Speed (kph)',
                            side: 'left',
                            overlaying: 'y2'
                        },
                        yaxis2: {
                            title: 'Fuel Use Per Hour (l/h)',
                            side: 'right',
                        },
                        legend: {
                            x: 1.1,
                            y: 1,
                            xanchor: 'left',
                            yanchor: 'top',
                        },
                    };

                    Plotly.newPlot(
                        'chartSpeedFuelUsage',
                        chartSpeedFuelUsage_traces,
                        chartSpeedFuelUsage_layout,
                    );

                    /*
                        =========================
                        Sync hover on Brake/Throttle and Speed/Fuel Usage
                        =========================
                    */
                    var chartBrakeThrottle = document.getElementById('chartBrakeThrottle');
                    var chartSpeedFuelUsage = document.getElementById('chartSpeedFuelUsage');

                    chartBrakeThrottle.on('plotly_hover', function(data) {
                        var curveNumber = data.points[0].curveNumber;
                        var pointIndex = data.points[0].pointIndex;

                        Plotly.Fx.hover('chartSpeedFuelUsage', [{
                            curveNumber: curveNumber, // match lap trace
                            pointNumber: pointIndex, // match point within the lap trace
                        }]);
                    });

                    chartBrakeThrottle.on('plotly_unhover', function(data) {
                        Plotly.Fx.unhover('chartSpeedFuelUsage');
                    });

                    chartSpeedFuelUsage.on('plotly_hover', function(data) {
                        var curveNumber = data.points[0].curveNumber;
                        var pointIndex = data.points[0].pointIndex;

                        Plotly.Fx.hover('chartBrakeThrottle', [{
                            curveNumber: curveNumber, // match lap trace
                            pointNumber: pointIndex, // match point within the lap trace
                        }]);
                    });

                    chartSpeedFuelUsage.on('plotly_unhover', function(data) {
                        Plotly.Fx.unhover('chartBrakeThrottle');
                    });

                    /*
                        =========================
                        Steering Angle and Torque
                        =========================
                    */
                    var chartSteeringAngleTorque_traces = [];

                    {% for lap, data in charts_info.items() %}
                        var angle_cleaned = {{ data['SteeringWheelAngle'] | tojson }}.map(angle => angle.toFixed(3));

                        chartSteeringAngleTorque_traces.push({
                            x: {{ data['Distance'] | tojson }},
                            y: {{ data['SteeringWheelAngle'] | tojson }},
                            yaxis: 'y1',
                            mode: 'lines',
                            name: 'L{{ lap }} Angle',
                            customdata: angle_cleaned.map(angle => angle > 0 ? '‚¨ÖÔ∏èüïπÔ∏è (' + angle + ' rad)' : 'üïπÔ∏è‚û°Ô∏è (' + angle + ' rad)'),
                            hovertemplate: '%{customdata}',
                            visible: {% if lap == laps_report_info['TopLaps'][0] %} true {% else %} 'legendonly' {% endif %},
                        });

                        var torque_cleaned = {{ data['SteeringWheelTorque'] | tojson }}.map(torque => torque.toFixed(3));

                        chartSteeringAngleTorque_traces.push({
                            x: {{ data['Distance'] | tojson }},
                            y: {{ data['SteeringWheelTorque'] | tojson }},
                            yaxis: 'y2',
                            mode: 'lines',
                            name: 'L{{ lap }} Torque',
                            customdata: torque_cleaned,
                            hovertemplate: 'üí™ %{customdata} N*m',
                            visible: {% if lap == laps_report_info['TopLaps'][0] %} true {% else %} 'legendonly' {% endif %},
                        });
                    {% endfor %}

                    var chartSteeringAngleTorque_layout = {
                        autosize: true,
                        showlegend: true,
                        title: 'Steering Wheel Angle and Torque',
                        xaxis: {
                            title: 'Distance (m)',
                        },
                        yaxis: {
                            title: 'Angle (rad)',
                            side: 'left',
                            overlaying: 'y2'
                        },
                        yaxis2: {
                            title: 'Torque (N*m)',
                            side: 'right',
                        },
                        legend: {
                            x: 1.1,
                            y: 1,
                            xanchor: 'left',
                            yanchor: 'top',
                        },
                    };

                    Plotly.newPlot(
                        'chartSteeringAngleTorque',
                        chartSteeringAngleTorque_traces,
                        chartSteeringAngleTorque_layout,
                    );

                    /*
                        =========================
                        Sync hover on Angle/Torque and Speed/Gear
                        =========================
                    */
                    var chartSteeringAngleTorque = document.getElementById('chartSteeringAngleTorque');
                    var chartSpeedGear = document.getElementById('chartSpeedGear');

                    chartSteeringAngleTorque.on('plotly_hover', function(data) {
                        var curveNumber = data.points[0].curveNumber;
                        var pointIndex = data.points[0].pointIndex;

                        Plotly.Fx.hover('chartSpeedGear', [{
                            curveNumber: curveNumber, // match lap trace
                            pointNumber: pointIndex, // match point within the lap trace
                        }]);
                    });

                    chartSteeringAngleTorque.on('plotly_unhover', function(data) {
                        Plotly.Fx.unhover('chartSpeedGear');
                    });

                    chartSpeedGear.on('plotly_hover', function(data) {
                        var curveNumber = data.points[0].curveNumber;
                        var pointIndex = data.points[0].pointIndex;

                        Plotly.Fx.hover('chartSteeringAngleTorque', [{
                            curveNumber: curveNumber, // match lap trace
                            pointNumber: pointIndex, // match point within the lap trace
                        }]);
                    });

                    chartSpeedGear.on('plotly_unhover', function(data) {
                        Plotly.Fx.unhover('chartSteeringAngleTorque');
                    });
                });
            </script>
        </div>
    </div>
</div>
